
# Authentik용 Nginx 프록시 설정 예시

# 대용량 헤더 처리를 위한 버퍼 크기 증가
# goauthentik으로 보호된 앱에서 'upstream sent too big header while reading response header from upstream' 에러가 발생할 때만 필요
proxy_buffers 8 16k;
proxy_buffer_size 32k;

# 메인 프록시 설정
location / {
    # 실제 서비스로 프록시 패스
    proxy_pass $forward_scheme://$server:$port;

    # authentik 인증 연동
    auth_request /outpost.goauthentik.io/auth/nginx;
    error_page 401 = @goauthentik_proxy_signin;
    auth_request_set $auth_cookie $upstream_http_set_cookie;
    add_header Set-Cookie $auth_cookie;

    # 인증 헤더 전달
    auth_request_set $authentik_username $upstream_http_x_authentik_username;
    auth_request_set $authentik_groups $upstream_http_x_authentik_groups;
    auth_request_set $authentik_email $upstream_http_x_authentik_email;
    auth_request_set $authentik_name $upstream_http_x_authentik_name;
    auth_request_set $authentik_uid $upstream_http_x_authentik_uid;

    proxy_set_header X-authentik-username $authentik_username;
    proxy_set_header X-authentik-groups $authentik_groups;
    proxy_set_header X-authentik-email $authentik_email;
    proxy_set_header X-authentik-name $authentik_name;
    proxy_set_header X-authentik-uid $authentik_uid;

    # 클라이언트 IP 전달
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# /outpost.goauthentik.io 경로는 인증 없이 접근 가능해야 함
location /outpost.goauthentik.io {
    # proxy_pass https://authentik-server:9443/outpost.goauthentik.io;
    proxy_pass https://192.168.1.13:9443/outpost.goauthentik.io;

    # 외부 URL과 호스트 헤더 일치 필요
    proxy_set_header Host $host;
    proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
    add_header Set-Cookie $auth_cookie;
    auth_request_set $auth_cookie $upstream_http_set_cookie;

    # POST 요청 처리를 위해 필요
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
}

# 인증 실패(401) 시 SSO 시작 URL로 리다이렉트
location @goauthentik_proxy_signin {
    internal;
    add_header Set-Cookie $auth_cookie;
    return 302 /outpost.goauthentik.io/start?rd=$request_uri;
    # 도메인 전체 리디렉션이 필요하다면 아래 주석을 참고
    # return 302 https://authentik.company/outpost.goauthentik.io/start?rd=$scheme://$http_host$request_uri;
}

# End of Selection
